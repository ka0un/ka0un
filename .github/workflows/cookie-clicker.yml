name: Cookie Clicker

on:
  issues:
    types: [opened]

jobs:
  update-leaderboard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq wget

      - name: Update leaderboard
        env:
          ACTIONS_PAT: ${{ secrets.ACTIONS_PAT }}
        run: |
          LAST_USER_FILE=last_user.txt
          SCORES_FILE=scores.txt
          LEADERBOARD_FILE=README.md

          # Extract the username of the user who clicked
          USERNAME=$(jq -r '.issue.user.login' "$GITHUB_EVENT_PATH")

          # Check if the same user clicked twice in a row
          if [ -f "$LAST_USER_FILE" ]; then
            LAST_USER=$(cat "$LAST_USER_FILE")
          else
            LAST_USER=""
          fi

          if [ "$USERNAME" == "$LAST_USER" ]; then
            echo "User $USERNAME clicked twice in a row. Ignoring click."
            exit 0
          fi

          # Update the scores in the text file
          if grep -q "^$USERNAME:" "$SCORES_FILE"; then
            sed -i "s/^$USERNAME:.*/$USERNAME: $(($(grep "^$USERNAME:" "$SCORES_FILE" | cut -d: -f2) + 1))/" "$SCORES_FILE"
          else
            echo "$USERNAME: 1" >> "$SCORES_FILE"
          fi

          # Get and sort users by clicks
          USERS=$(sort -t: -k2,2nr "$SCORES_FILE")

          # Generate leaderboard markdown table
          LEADERBOARD="| Place | Profile Pic | Name | Score |\n|-------|-------------|------|-------|\n"
          PLACE=1
          while IFS=: read -r NAME SCORE; do
            if [ "$PLACE" -le 10 ]; then
              PROFILE_PIC="https://github.com/${NAME}.png?size=40" # Example URL
              LEADERBOARD+="| $PLACE | ![$NAME]($PROFILE_PIC) | $NAME | $SCORE |\n"
              PLACE=$((PLACE + 1))
            fi
          done <<< "$USERS"

          # Update the README with the new leaderboard
          awk -v leaderboard="$LEADERBOARD" '
            /<!-- LEADERBOARD_START -->/ { print; print leaderboard; next }
            /<!-- LEADERBOARD_END -->/ { print; next }
            { print }
          ' "$LEADERBOARD_FILE" > temp.md && mv temp.md "$LEADERBOARD_FILE"

          # Update last user in the file
          echo "$USERNAME" > "$LAST_USER_FILE"

          # Commit the changes
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$SCORES_FILE" "$LEADERBOARD_FILE" "$LAST_USER_FILE"
          git commit -m "Update leaderboard for $USERNAME"

          # Push changes
          echo "Using PAT for git push"
          git push https://${{ secrets.ACTIONS_PAT }}@github.com/${{ github.repository }}.git HEAD:main

      - name: Delete the triggering issue
        env:
          ACTIONS_PAT: ${{ secrets.ACTIONS_PAT }}
        run: |
          ISSUE_NUMBER=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")
          echo "Deleting issue #$ISSUE_NUMBER"
          curl -s -X DELETE -H "Authorization: token $ACTIONS_PAT" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER"

